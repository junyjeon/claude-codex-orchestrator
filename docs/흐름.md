# 흐름

## 기본 플로우

```
사용자: "binary search 함수 구현해줘"
    ↓
Claude Code: 요청 이해 및 판단
    ↓
Claude Code: generate_code 도구 호출 결정
    ↓
MCP 서버: Codex CLI 실행
    ↓
Codex CLI: 코드 생성
    ↓
MCP 서버: 결과 반환
    ↓
Claude Code: 코드 검증 및 제시
    ↓
사용자: 생성된 코드 확인
```

## 상세 단계

### 1. 사용자 요청
사용자가 Claude Code에 코드 생성을 요청한다.

예시:
- "binary search 알고리즘 TypeScript로 만들어줘"
- "Express 라우터 보일러플레이트"
- "React 훅 5개"

### 2. Claude Code 판단
Claude Code가 요청을 분석한다.

판단 기준:
- 코드 생성 작업인가?
- Codex가 적합한가?
- 어떤 컨텍스트가 필요한가?

### 3. MCP 도구 호출
Claude Code가 generate_code 도구를 호출한다.

파라미터:
- task_description: "binary search function"
- language: "typescript"
- context: (optional) 추가 컨텍스트

### 3.5 프롬프트 변환

MCP 서버가 파라미터를 Codex 프롬프트로 변환한다.

**포맷:**
```
Generate {language} code: {task_description}

Context: {context}
```

**예시:**

"quicksort 함수 Python으로"
→ Claude Code 구조화: `{ task_description, language: "python", context }`
→ MCP 서버: `"Generate python code: quicksort..."`
→ Codex stdin 전달

**핵심:**
사용자 자연어 → Claude Code 구조화 → MCP 포맷 변환 → Codex 실행

### 4. Codex CLI 실행
MCP 서버가 Codex CLI를 실행한다.

stdin 파이프 방식 (보안 강화):
```bash
echo "Generate typescript code: binary search function" | codex exec -
```

spawn 방식:
- Command injection 방지
- 프롬프트 길이 제한 없음
- 안전한 프로세스 관리

타임아웃: 30초 (기본값)

### 5. 결과 반환
Codex CLI의 stdout을 그대로 반환한다.

성공 시:
- 생성된 코드
- 실행 시간

실패 시:
- 에러 메시지
- 실패 원인

### 6. Claude Code 검증
Claude Code가 생성된 코드를 검증한다.

검증 항목:
- Syntax 체크
- Type 체크
- 프로젝트 패턴 일치
- 보안 이슈

### 7. 사용자에게 제시
Claude Code가 코드를 사용자에게 보여준다.

추가 작업:
- 파일 생성
- 기존 코드와 통합
- 설명 추가

## 에러 처리

### Codex CLI 미설치
MCP 서버가 에러 반환:
"Codex CLI not found. Please install..."

Claude Code가 사용자에게 안내 또는 자체 생성으로 폴백

### 인증 실패
MCP 서버가 에러 반환:
"Codex authentication failed. Please run: codex login"

사용자가 직접 인증 필요

### 타임아웃
30초 후 타임아웃:
"Codex CLI timeout after 30000ms"

Claude Code가 재시도 또는 자체 생성

### 생성 실패
Codex가 코드를 생성하지 못함

Claude Code가 직접 생성하거나 사용자에게 명확한 스펙 요청

## 성능

일반적인 실행 시간:
- 단순 함수: 2-5초
- 복잡한 로직: 5-10초
- 보일러플레이트: 3-7초

Claude Code 직접 생성 대비:
- 비슷하거나 약간 빠름
- 품질은 작업 유형에 따라 다름
